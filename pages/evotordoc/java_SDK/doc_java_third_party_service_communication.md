---
title: Обмен сообщениями со сторонним сервисом
keywords:
summary:
sidebar: evotordoc_sidebar
permalink: doc_java_third_party_service_communication.html
tags: [Терминал, Java, JavaScript]
folder: java_SDK
---

Все запросы приложений к стороннему сервису проходят через Облако Эвотор:

![](images\cloud_proxy.png)

Для отправки запросов требуется:

* На портале [dev.evotor.ru](https://dev.evotor.ru), указать список разрешённых URL, к которым может обращаться приложение.
* Поддержать возможность обращения к сторонним сервисам в приложении. Способ обращения отличается в зависимости от типа приложения (Java или JS).

### Настройка списка разрешённых URL

Чтобы настроить список разрешённых URL:

1. На портале [dev.evotor.ru](https://dev.evotor.ru) выберите приложение, для которого требуется указать список разрешённых URL.
2. На вкладке **Интеграция**, установите флажок **Проксирование запросов из приложения с терминала на ваш сервер (ver. 2)** и укажите список URL, к которым может обращаться приложение.

Примеры:

* `http://example\.com/document.*\.jsp\?wildcard=\*&param=value.*`;
* `https://another\.host\.com/document.*\.jsp`;
* `https://another\.host\.com/.*`.

{% include note.html content="Чтобы задавать маски веб-сайтов используйте [регулярные выражения](http://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html#sum)." %}

После создания списка, обмен сообщениями происходит по описанному ниже процессу.

### Шаг 1. Приложение отправляет HTTP-сообщение

Приложение создаёт HTTP-сообщение и отправляет его в сторонний сервис. Вы можете воспользоваться любым удобным способом отправки сообщения.

Например, для отправки HTTP-сообщения из Java-приложения вы можете, например, использовать [библиотеку OkHttp](http://square.github.io/okhttp/) или способ, описанный на [developer.android.com](https://developer.android.com/training/basics/network-ops/connecting.html).



### Шаг 2. Смарт-терминал передаёт сообщение в облако

Терминал перехватывает сообщение и передаёт его в облако Эвотор.

{% include note.html content="Убедитесь, что ваше приложение не использует перечисленные ниже заголовки. В противном случае, смарт-терминал перезапишет их содержимое." %}

* `X-Device-ID`
* `X-Device-IMEI`
* `X-User-ID`
* `X-Signed-Url`
* `X-Shop-UUID`
* `X-Device-Salt`
* `X-Device-Algorithm`
* `X-Device-Date`
* `X-Secret-Device-ID`
* `X-OAuth-Client-ID`
* `X-Device-UUID`
* `X-Evotor-*`
* `Expect`
* `Host`
* `Transfer-Encoding`

### Шаг 3. Облако передаёт сообщение адресату

Облако удаляет служебные заголовки, добавляет свои заголовки и передаёт сообщение адресату.

Заголовки, которые добавляет облако:

* `X-Evotor-Store-Uuid` – содержит идентификатор магазина в формате uuid4, к которому привязан терминал.
* `X-Evotor-Device-UUID` – содержит идентификатор устройства в формате uuid4, полученный по запросу к `/api/v1/inventories/devices`.
* `Authorization` – содержит [токен стороннего сервиса](./doc_authorization.html#serverToken). Токен необходим для bearer-авторизации.

Сторонний сервер получает сообщение от облака Эвотор и определяет отправителя с помощью заголовка Authorization.

#### Шаг 4. Ответ стороннего сервиса

Ответ стороннего сервиса передаётся приложению в обратном порядке.

Ответы стороннего сервиса должны содержать объекты:

  * `status` – содержит HTTP-код состояния.
  * `body` – содержит тело запроса.
