---
title: Обмен сообщениями со сторонним сервисом
keywords:
summary:
sidebar: evotordoc_sidebar
permalink: doc_js_third_party_service_communication.html
tags: [Терминал, JavaScript]
folder: JS_SDK
---

Все запросы приложений к стороннему сервису проходят через Облако Эвотор:

{: .center-image}
![](images\cloud_proxy.png)

Для отправки запросов приложения могут использовать только 80 и 443 порт.

Для отправки запросов требуется:

* На портале [dev.evotor.ru](https://dev.evotor.ru), указать список разрешённых URL, к которым может обращаться приложение.
* Поддержать возможность обращения к сторонним сервисам в приложении.

{% include note.html content="Если вы разрабатываете Java-приложение, смотрите раздел [Обмен сообщениями Java-приложения и стороннего сервиса](./doc_java_third_party_service_communication.html)." %}

### Настройка списка разрешённых URL

Чтобы настроить список разрешённых URL:

1. На портале [dev.evotor.ru](https://dev.evotor.ru) выберите приложение, для которого требуется указать список разрешённых URL.
2. На вкладке **Интеграция**, установите флажок **Проксирование запросов из приложения с терминала на ваш сервер (ver. 2)** и укажите список URL, к которым может обращаться приложение.

Примеры:

* `http://example\.com/document.*\.jsp\?wildcard=\*&param=value.*`;
* `https://another\.host\.com/document.*\.jsp`;
* `https://another\.host\.com/.*`.

{% include note.html content="Чтобы задавать маски веб-сайтов используйте [регулярные выражения](http://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html#sum)." %}

После создания списка, обмен сообщениями происходит по описанному ниже процессу.

### Шаг 1. Приложение отправляет HTTP-сообщение

Приложение создаёт HTTP-сообщение и отправляет его в сторонний сервис. Вы можете воспользоваться любым удобным способом отправки сообщения.

Убедитесь что в файле `client.yaml`, в списке `capabilities`, указан модулю для отправки HTTP-запросов:

```yaml
capabilities:
  - internet
```

Отправляйте запросы с помощью методов объекта `http`. Объект `http` доступен во view.html без подключения модуля.

Чтобы получить доступ к объекту `http` в плагине или демоне, требуется подключить модуль:

```javascript
var http = require('http')
```

{% include note.html content="Во view.html вы также можете использовать ajax или другие способы обмена сообщениями." %}

#### Метод для GET-запроса

```javascript
http.get(url: String)
```

В аргументе метода требуется передать URL, по которому выполняется GET-запрос.

#### Метод для POST-запроса

```javascript
http.post(url: String, payload: String, mediaType: String)
```

В аргументе метода требуется передать URL, по-которому выполняется POST-запрос и тело запроса.

### Шаг 2. Смарт-терминал передаёт сообщение в облако

Терминал перехватывает сообщение и передаёт его в облако Эвотор.

{% include note.html content="Убедитесь, что ваше приложение не использует перечисленные ниже заголовки. В противном случае, смарт-терминал перезапишет их содержимое." %}

* `X-Device-ID`
* `X-Device-IMEI`
* `X-User-ID`
* `X-Signed-Url`
* `X-Shop-UUID`
* `X-Device-Salt`
* `X-Device-Algorithm`
* `X-Device-Date`
* `X-Secret-Device-ID`
* `X-OAuth-Client-ID`
* `X-Device-UUID`
* `X-Evotor-*`
* `Expect`
* `Host`
* `Transfer-Encoding`

### Шаг 3. Облако передаёт сообщение адресату

Облако удаляет служебные заголовки, добавляет свои заголовки и передаёт сообщение адресату.

Заголовки, которые добавляет облако:

* `X-Evotor-Store-Uuid` – содержит идентификатор магазина в формате uuid4, к которому привязан терминал.
* `X-Evotor-Device-UUID` – содержит идентификатор устройства в формате uuid4, полученный по запросу к `/api/v1/inventories/devices`.
* `Authorization` – содержит [токен стороннего сервиса](./doc_authorization.html#serverToken). Токен необходим для bearer-авторизации.

Сторонний сервер получает сообщение от облака Эвотор и определяет отправителя с помощью заголовка Authorization.

#### Шаг 4. Ответ стороннего сервиса

Ответ стороннего сервиса передаётся приложению в обратном порядке.

Ответы стороннего сервиса должны содержать объекты:

  * `status` – содержит HTTP-код состояния.
  * `body` – содержит тело запроса.
