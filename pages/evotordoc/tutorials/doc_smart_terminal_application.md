---
title: Приложение для смарт-терминала
keywords: sample
summary: "Раздел содержит информацию, которая потребуется при разработке приложения для терминала."
sidebar: evotordoc_sidebar
permalink: doc_smart_terminal_application.html
tags: [Java, JavaScript, Терминал, Облако]
folder: evotordoc/evotor_tutorials
---

Ваше приложение для смарт-терминала может быть написано на языке Java или JavaScript.

> Обратите внимание, что `packagename` вашего приложения должен соответствовать правилам, описанным [в документации Oracle](https://docs.oracle.com/javase/tutorial/java/package/namingpkgs.html).

Процесс установки и активации приложения для смарт терминала, отличается в зависимости от того, взаимодействует приложение со сторонним сервисом или нет.

### Приложение не взаимодействует со сторонним сервисом

После покупки приложения в Магазине приложений, Эвотор автоматически устанавливает его на смарт терминал, при наличии подключения к Интернету.

### Приложение взаимодействует со сторонним сервисом

Если приложение взаимодействует со сторонним сервисом, убедитесь, что сторонний сервис поддерживает URL, указанные в таблице ниже.

|                URL               |                                                                     Назначение                                                                    |                                                                Авторизация                                                                |                                                      Дополнительно                                                     |
|:--------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------|:----------------------------------------------------------------------------------------------------------------------|
| https://example.com/api/v1/user/create | Эвотор отправляет по адресу регистрационные данные для создания новой учётной записи в облачной товароучётной системе.                     | Товароучётная система авторизует запрос облака с помощью имени пользователя и пароля (basic-авторизация) или токена (bearer-авторизация). |                                                                                                                        |
| https://example.com/api/v1/user/verify | Эвотор отправляет по адресу данные для авторизации пользователя в облачной товароучётной системе с помощью ранее созданной учётной записи. |                                                                                                                                           |                                                                                                                        |   |

<!-- Если приложение платное, сторонний сервис должен также поддерживать адрес  `https://example.com/api/v1/user/tariff`. На этот адрес Эвотор отправляет идентификатор пользователя Эвотор и идентификатор тарифа в стороннем сервисе. Идентификатор тарифа вы указываете в процессе разработки приложения на сайте https://dev.evotor.ru/, в разделе Тарифы. -->

Так же, если приложению требуется доступ к REST API Эвотора, сторонний сервис должен поддерживать адрес `https://example.com/api/v1/user/token`.

#### Покупка и активация приложения для смарт-терминала

![Схема покупки и активации приложения](images/smart_terminal_application_handling.png "Схема покупки и активации приложения")

##### Этап 1

{% include embeds/application_installation_stage1.html %}

##### Этап 2

{% include embeds/application_installation_stage2.html %}

#### Взаимодействие приложения и стороннего сервиса

Эвотор проксирует все запросы от приложения к стороннему сервису, а также ответы стороннего сервиса.

Чтобы приложение обменивалось сообщениями со сторонним сервисом, выполните следующие действия:
1. На сайте разработчиков, выберите необходимое приложение и перейдите на вкладку **Интеграция**.
3. Установите следующие флажки:
  * **Проксирование запросов из приложения с терминала на ваш сервер (ver.2)**, где в поле **URL** требуется указать основной URL стороннего сервиса (baseUrl). Сообщения приложения содержат путь относительно указанного URL.
  * **Регистрация учётной записи в стороннем сервисе**, где в поле **URL** требуется указать URL вида `https://partner.ru/api/v1/create` (см. таблицу выше).
  * **Авторизация учётной записи в стороннем сервисе**, где в поле **URL** требуется указать URL вида `https://partner.ru/api/v1/verify` (см. таблицу выше).
4. [Выложите приложение на тест, чтобы изменения вступили в силу](doc_application_test.html).
5. Установите приложение Личном кабинете пользователя Эвотор.
6. В Личном кабинете, на вкладке **Установка / удаление** приложения, выберите смарт-терминалы, с которых приложение сможет отправлять запросы в сторонний сервис.

Процесс обмена сообщениями между приложением и сторонним сервисом выглядит так:

1. Приложение создаёт запрос, указывает его тело и относительный путь на сервере стороннего сервиса.
2. Эвотор проверяет, что смарт-терминал привязан к приложению, которое отправляет запрос.
3. Эвотор добавляет к сообщению приложения заголовки:
  * `X-Evotor-Store-Uuid` -- содержит идентификатор магазина в формате uuid4, к которому привязан терминал.
  * `X-Evotor-Device-UUID` – содержит идентификатор устройства в формате uuid4, полученный по запросу к `/api/v1/inventories/devices`.
  * `Authorization` -- содержит токен пользователя. Токен необходим для bearer-авторизации.
4. Эвотор передаёт запрос приложения в сторонний сервис по адресу, состоящему из основного URL сервиса и относительного пути.

Сторонний сервис передаёт сообщения к приложению в обратном порядке. Эвотор авторизует сообщения с помощью токена приложения. Сообщения стороннего сервиса должны содержать объекты:
  * `status` -- содержит HTTP-код состояния.
  * `body` -- содержит тело запроса.

### Режим разработчика

Для отладки приложения, вы можете [включить Режим разработчика](./doc_developer_mode.html). Режим разработчика предоставляет доступ к логам приложения и позволяет загружать приложение напрямую на смарт-терминал.

Для доступа к логам приложения используйте Android Debug Bridge.

> Внимание: не устанавливайте на смарт-терминал более одного приложения в режиме разработчика одновременно.

### Удаление и деактивация приложения

Эвотор останавливает интеграцию и удаляет приложение если:
* пользователь самостоятельно удалил приложение в разделе **Мои приложения** в Личном кабинете пользователя Эвотор;
* у пользователя недостаточно средств для продления подписки.

В обоих случаях Эвотор передаёт в сторонний сервис запрос [**\[POST\] Активация / деактивация тарифа**](https://goo.gl/V71Guj) с состоянием `INACTIVE`.

#### Повторная установка приложения

При повторной установке приложения Эвотор проверяет истёк пробный период использования приложения или нет. Так же если при повторной установке пользователь авторизовался в стороннем сервисе с помощью существующей учётной записи и сторонний сервис вернул `haslBilling: true`, блиллинг пользователя будет выполнять сторонний сервис. Независимо от того, кто выполнял биллинг при первичной установке.
